FROM ubuntu:22.04

# Prevent prompts
ENV DEBIAN_FRONTEND=noninteractive

# Base dependencies
RUN apt-get update && apt-get install -y \
  curl wget git sudo unzip gnupg \
  libx11-dev libxkbfile-dev libsecret-1-dev \
  libssl-dev pkg-config zlib1g-dev \
  build-essential ca-certificates \
  software-properties-common

# Install Node.js (v18)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# Install Rust
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y && \
    echo 'source $HOME/.cargo/env' >> ~/.bashrc
ENV PATH="/root/.cargo/bin:${PATH}"

# Install DFX CLI (v0.28.0)
RUN curl -LO https://github.com/dfinity/sdk/releases/download/0.28.0/dfx-0.28.0-x86_64-linux.tar.gz && \
    tar -xvzf dfx-0.28.0-x86_64-linux.tar.gz && \
    chmod +x dfx && \
    mv dfx /usr/local/bin/dfx && \
    rm -f dfx-0.28.0-x86_64-linux.tar.gz && \
    dfx --version    

    # ./dfx/install.sh && \
    # rm -rf dfx-0.28.0-x86_64-linux*

# Create a user to run code-server
RUN useradd -m coder && \
    echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER coder
WORKDIR /home/coder

# Install code-server (no password in ENV)
RUN wget https://github.com/coder/code-server/releases/download/v4.89.1/code-server_4.89.1_amd64.deb && \
    sudo dpkg -i code-server_4.89.1_amd64.deb && \
    rm code-server_4.89.1_amd64.deb

# Configure code-server
RUN mkdir -p ~/.config/code-server && \
    echo 'bind-addr: 0.0.0.0:8443' > ~/.config/code-server/config.yaml && \
    echo 'auth: password' >> ~/.config/code-server/config.yaml && \
    echo 'password: icpad' >> ~/.config/code-server/config.yaml && \
    echo 'cert: false' >> ~/.config/code-server/config.yaml

# Expose port
EXPOSE 8443

# Optional extensions
RUN code-server --install-extension rust-lang.rust-analyzer && \
    code-server --install-extension dbaeumer.vscode-eslint

CMD ["code-server"]
