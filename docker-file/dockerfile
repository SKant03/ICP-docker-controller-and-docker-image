FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install base dependencies
RUN apt-get update && apt-get install -y \
  curl wget git sudo unzip gnupg \
  libx11-dev libxkbfile-dev libsecret-1-dev \
  libssl-dev pkg-config zlib1g-dev \
  build-essential ca-certificates \
  software-properties-common \
  net-tools && \
  rm -rf /var/lib/apt/lists/*

# Install Node.js v18
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm

# Install Rust
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y && \
    echo 'source $HOME/.cargo/env' >> /etc/bash.bashrc
ENV PATH="/root/.cargo/bin:${PATH}"

# Install DFX CLI
RUN curl -LO https://github.com/dfinity/sdk/releases/download/0.28.0/dfx-0.28.0-x86_64-linux.tar.gz && \
    tar -xvzf dfx-0.28.0-x86_64-linux.tar.gz && \
    chmod +x dfx && mv dfx /usr/local/bin/dfx && \
    rm -f dfx-0.28.0-x86_64-linux.tar.gz && \
    dfx --version

# Create non-root user
RUN useradd -m coder && \
    echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER coder
WORKDIR /home/coder

# Install code-server
RUN wget https://github.com/coder/code-server/releases/download/v4.89.1/code-server_4.89.1_amd64.deb && \
    sudo dpkg -i code-server_4.89.1_amd64.deb && \
    rm code-server_4.89.1_amd64.deb

# Create data directories for code-server
RUN mkdir -p /home/coder/.local/share/code-server/extensions \
    /home/coder/.local/share/code-server/User \
    /home/coder/.local/share/code-server/Machine \
    && chown -R coder:coder /home/coder/.local

# Set default password (can be overridden at runtime with -e PASSWORD=newpass)
ENV PASSWORD=icpad

# Configure code-server (no hardcoded password here)
RUN mkdir -p /home/coder/.config/code-server && \
    echo 'bind-addr: 0.0.0.0:8443' > /home/coder/.config/code-server/config.yaml && \
    echo 'auth: password' >> /home/coder/.config/code-server/config.yaml && \
    echo 'cert: false' >> /home/coder/.config/code-server/config.yaml

# Install extensions
RUN code-server --install-extension rust-lang.rust-analyzer && \
    code-server --install-extension dbaeumer.vscode-eslint

EXPOSE 8443

# Ensure correct PATH for `coder`
ENV PATH="/home/coder/.cargo/bin:${PATH}"

# Start code-server using ENV password or config.yaml
CMD ["code-server", "--bind-addr", "0.0.0.0:8443", "--disable-telemetry", "/home/coder/project"]
